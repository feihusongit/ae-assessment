version: 2

models:
  - name: client_transaction_summary_monthly
    description: "Monthly client-level summary of inbound transactions, revenue, and discounts."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - client_id
            - transaction_month

    columns:
      - name: transaction_month
        description: "Start-of-month bucket for the transactions (YYYY-MM-01 00:00:00)."
        tests:
          - not_null

      - name: client_id
        description: "Client identifier."
        tests:
          - not_null

      - name: total_transaction_count
        description: "Distinct transaction count in the month. for transaction type: payment/chargeback/fraud"

      - name: total_transaction_amount_gbp
        description: "Sum of GBP transaction amounts"

      - name: total_refunded_transaction_count
        description: "Count of transactions that had at least one refund."
        tests:
          - not_null

      - name: total_refunded_amount_gbp
        description: "Sum of GBP refund amounts."

      - name: original_monthly_platform_fee_margin
        description: "Original (pre-discount) platform fee margin."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "original_monthly_platform_fee_margin >= 0 AND original_monthly_platform_fee_margin <= 1"

      - name: actual_monthly_platform_fee_margin
        description: "Applied platform fee margin for the month after discount evaluation. If not met, use original margin"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "actual_monthly_platform_fee_margin >= 0 and actual_monthly_platform_fee_margin <= 1"

      - name: monthly_gmv_gbp
        description: "Sum of final_transacted_amount_gbp over (client_id, transaction_month)."

      - name: contracted_monthly_spend_threshold
        description: "Contracted monthly GBP spend threshold for the client-month (if any)."
                            
      - name: monthly_spend_threshold_reached
        description: "True if monthly_gmv_gbp meets/exceeds the contract threshold."
        tests:
          - accepted_values:
              values: [true, false]

      - name: revenue_gbp_pre_discount
        description: "monthly_gmv_gbp * original_monthly_platform_fee_margin."

      - name: revenue_gbp_post_discount
        description: "monthly_gmv_gbp * actual_monthly_platform_fee_margin."

      - name: discount_applided_gbp
        description: "Revenue difference due to discount: pre-discount - post-discount. 0 if no discount applied"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "discount_applided_gbp = actual_revenue_gbp_pre_discount - actual_revenue_gbp_post_discount"
    
    

